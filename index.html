// Adiciona a biblioteca de conversão no head do teu HTML
// <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>

const form = document.getElementById('scrimForm');
const chat = document.getElementById('chat-box');

form.onsubmit = async (e) => {
    e.preventDefault();
    // ... (lógica de envio de imagens permanece igual)

    try {
        const response = await fetch('https://phymatic-nonarresting-kareen.ngrok-free.dev/webhook/processar-scrim', {
            method: 'POST',
            headers: { 'Authorization-Key': key },
            body: formData
        });

        const data = await response.json(); // Recebe o JSON com o HTML
        const htmlBruto = data[0].htmlTable;

        // 1. Cria um elemento invisível para renderizar a tabela
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        tempDiv.innerHTML = htmlBruto;
        document.body.appendChild(tempDiv);

        // 2. Converte o elemento HTML em Imagem PNG
        const dataUrl = await htmlToImage.toPng(tempDiv);
        
        // 3. Exibe no chat
        const botMsg = document.createElement('div');
        botMsg.className = 'chat-msg bot shadow-sm';
        botMsg.innerHTML = `
            <p class="font-bold">✅ Tabela Gerada!</p>
            <img src="${dataUrl}" class="mt-2 rounded-lg border w-full">
            <a href="${dataUrl}" download="scrim_tabela.png" class="text-blue-600 underline text-sm mt-2 block">Baixar Imagem</a>
        `;
        chat.appendChild(botMsg);
        
        document.body.removeChild(tempDiv); // Limpa o rastro
    } catch (err) {
        console.error(err);
    }
};